(common) {
    root /var/run/caddy/public_html
    index index.html
	browse
	gzip
	push
	header / Access-Control-Allow-Origin *

    log / /var/log/caddy/access.log "{combined} {latency_ms}" {
		rotate_size 50  # Rotate after 50 MB
		rotate_age  7  # Keep rotated files for 7 days
		rotate_keep 10  # Keep at most 10 log files
		rotate_compress # Compress rotated log files in gzip format
		# ipmask 255.255.0.0 ffff:ffff:ffff:ff00:: #anonymied traffic
	}
}

(tile-edge-proxy) {
	proxy  /v1/api map3:80 {
    	health_check /server_status
    	health_check_interval 30s
    	health_check_timeout 60s
    }

    proxy  /v1/debug/var map3:80 {
    	health_check /server_status
    	health_check_interval 30s
    	health_check_timeout 60s
    }

    proxy / titan:80 {
    	health_check /server_status
    	health_check_interval 30s
    	health_check_timeout 60s
    }

    # new proxy for namespace:/api/{version}/{provider}/{mapname}/{z}/{x}/{y}.{ext}
    proxy /api/v1/hyn map3:80 {
    	health_check /server_status
    	health_check_interval 30s
    	health_check_timeout 60s
    }
}

(tile-edge-mapillary) {
    #mapillary sequence layer
    rewrite /api/v0.1/mapillary/sequence_layer {
        r  (.*)
        to /v0.1/{1}
    }
    proxy /v0.1 https://tiles3.mapillary.com
    cache {
        match_path /api/v0.1/mapillary/sequence_layer
        match_header Content-Type application/vnd.mapbox-vector-tile
        status_header X-Cache-Status-Map3-Edge
        default_max_age 60m
        path /etc/caddy/cache
	}
}

(tile-edge-auth) {
	tls keyless key.tile.map3.network:5001 /etc/caddy/tile-server.pem /etc/caddy/tile-ca.pem
	jwt {
        path /v1/api/tile/
    #    publickey /etc/caddy/jwt-key.pub
    #    allow ml mapstore
    #    allow ml map3free
         passthrough
    }

	jwt {
        path /api/v1/hyn/
        # publickey /etc/caddy/jwt-key.pub
        # allow ml mapstore
        # allow ml map3free
        passthrough
    }
}

(tile-edge-base-auth) {
	jwt {
        path /v1/api/tile/
    #    publickey /etc/caddy/jwt-key.pub
    #    allow ml mapstore
    #    allow ml map3free
         passthrough
    }

	jwt {
        path /api/v1/hyn/
        #publickey /etc/caddy/jwt-key.pub
        # allow ml mapstore
        # allow ml map3free
        passthrough
    }
}

*.tile.map3.network:443 {
    import common
    import tile-edge-proxy
    import tile-edge-auth
}

:80 {
    import common
    import tile-edge-proxy
    import tile-edge-base-auth
    import tile-edge-mapillary
}
